<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Osaajatori ‚Äì Osaajat ilman v√§lik√§si√§</title>
  <meta name="description" content="L√∂yd√§ ja palkkaa pienyritt√§ji√§ suoraan. Profiilit, haku ja turvalliset maksulinkit." />
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    html, body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans'; }
    .chip { display:inline-flex; align-items:center; gap:.25rem; padding:.25rem .6rem; border-radius:999px; background:#f1f5f9; font-size:.75rem; color:#334155; }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.6rem 1rem; border-radius:1rem; font-weight:600; }
    .btn-primary { background:#2563eb; color:#fff; }
    .btn-outline { border:1px solid #cbd5e1; color:#0f172a; }
    .input { width:100%; border:1px solid #cbd5e1; border-radius:.75rem; padding:.6rem .9rem; outline:none; }
    .card { background:#fff; border:1px solid #e2e8f0; border-radius:1rem; }
    .shadow-soft { box-shadow: 0 10px 35px rgba(2,6,23,.08); }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
      <div class="font-extrabold text-xl">Osaajatori</div>
      <nav class="hidden md:flex items-center gap-6 text-sm">
        <a href="#home" class="hover:text-blue-700">Etusivu</a>
        <a href="#search" class="hover:text-blue-700">Haku</a>
        <a href="#account" class="hover:text-blue-700">Tilini</a>
        <a href="#admin" id="navAdmin" class="hover:text-blue-700 hidden">Admin</a>
      </nav>
      <div class="flex items-center gap-2">
        <button class="btn btn-outline" id="btnLogin">Kirjaudu</button>
        <button class="btn btn-primary" id="btnLogout" style="display:none">Kirjaudu ulos</button>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section id="home" class="relative">
    <div class="absolute inset-0 bg-gradient-to-b from-blue-50 to-transparent"></div>
    <div class="relative mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 pt-10 pb-8">
      <div class="grid md:grid-cols-2 gap-8 items-center">
        <div>
          <h1 class="text-4xl md:text-5xl font-extrabold leading-tight">L√∂yd√§ luotettava osaaja. <span class="text-blue-700">Ilman v√§lik√§si√§.</span></h1>
          <p class="mt-4 text-slate-700 text-lg">Vertaile hintoja, lue arvosteluja ja osta turvallisesti maksulinkin kautta.</p>
          <div class="mt-6 card p-3 shadow-soft">
            <form id="heroSearch" class="grid sm:grid-cols-5 gap-3">
              <input class="input sm:col-span-2" name="q" placeholder="Esim. valokuvaaja" />
              <input class="input sm:col-span-1" name="city" placeholder="Paikkakunta" />
              <select class="input sm:col-span-1" name="category">
                <option value="">Kaikki alat</option>
                <option>Valokuvaus</option>
                <option>Graafinen suunnittelu</option>
                <option>Verkkosivut</option>
                <option>K√§√§nt√§minen</option>
                <option>Kirjanpito</option>
              </select>
              <button class="btn btn-primary sm:col-span-1" type="submit">Hae</button>
            </form>
            <p class="mt-2 text-sm text-slate-600">üí° Vapaateksti toimii: ‚Äúedullinen valokuvaaja Espoossa syyskuulle‚Äù.</p>
          </div>
          <div class="mt-4 flex flex-wrap gap-2 text-sm">
            <span class="chip">‚úî Turvallinen maksu</span>
            <span class="chip">‚úî Arvostelut</span>
            <span class="chip">‚úî Hyv√§ksynt√§ ennen julkaisua</span>
          </div>
        </div>
        <div class="md:pl-8">
          <div class="card p-4 shadow-soft">
            <img class="rounded-2xl w-full object-cover" src="https://images.unsplash.com/photo-1498050108023-c5249f4df085?q=80&w=1200&auto=format&fit=crop" alt="Freelancer"/>
            <div class="mt-3 text-sm text-slate-600">*Kuvitus.*</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Search -->
  <section id="search" class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 pb-16">
    <div class="flex items-end justify-between gap-4">
      <div>
        <h2 class="text-2xl font-bold">Selaa osaajia</h2>
        <p class="text-slate-600">Vain hyv√§ksytyt profiilit n√§kyv√§t julkisesti.</p>
      </div>
      <div class="flex items-center gap-2">
        <label class="text-sm text-slate-600">J√§rjest√§</label>
        <select id="sortSelect" class="input max-w-[200px]">
          <option value="relevance">Osuvuus</option>
          <option value="rating">Arvostelu</option>
          <option value="price_asc">Hinta nouseva</option>
          <option value="price_desc">Hinta laskeva</option>
        </select>
      </div>
    </div>

    <div class="grid md:grid-cols-[280px,1fr] gap-6 mt-6">
      <aside class="card p-4 h-fit sticky top-20">
        <div class="space-y-4">
          <div>
            <label class="text-sm font-medium">Hakusana</label>
            <input id="filterQ" class="input mt-1" placeholder="esim. logo / h√§√§kuvat" />
          </div>
          <div>
            <label class="text-sm font-medium">Paikkakunta</label>
            <input id="filterCity" class="input mt-1" placeholder="esim. Helsinki" />
          </div>
          <div>
            <label class="text-sm font-medium">Ala</label>
            <select id="filterCategory" class="input mt-1">
              <option value="">Kaikki</option>
              <option>Valokuvaus</option>
              <option>Graafinen suunnittelu</option>
              <option>Verkkosivut</option>
              <option>K√§√§nt√§minen</option>
              <option>Kirjanpito</option>
            </select>
          </div>
          <div>
            <label class="text-sm font-medium">Tuntihinta (max)</label>
            <input id="filterPrice" type="range" min="20" max="200" value="200" class="w-full"/>
            <div class="text-xs text-slate-600">Max: <span id="priceValue">200</span> ‚Ç¨/h</div>
          </div>
          <div class="flex gap-2">
            <button id="applyFilters" class="btn btn-primary w-full">K√§yt√§ suodattimet</button>
            <button id="resetFilters" class="btn btn-outline w-full">Tyhjenn√§</button>
          </div>
        </div>
      </aside>

      <div>
        <div id="results" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-5"></div>
        <div id="emptyState" class="hidden text-center py-16">
          <p class="text-lg font-semibold">Ei tuloksia n√§ill√§ ehdoilla</p>
          <p class="text-slate-600 mt-1">Kokeile v√§ljempi√§ hakuehtoja.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Account (create/edit profile) -->
  <section id="account" class="mx-auto max-w-3xl px-4 sm:px-6 lg:px-8 pb-16">
    <h2 class="text-2xl font-bold">Tilini & Profiili</h2>
    <p class="text-slate-600">Luo tai muokkaa profiiliasi. Profiili n√§kyy julkisesti <strong>vasta kun admin hyv√§ksyy</strong>.</p>
    <div class="card p-4 mt-4">
      <form id="profileForm" class="grid gap-3">
        <input class="input" name="name" placeholder="Nimi" required />
        <input class="input" name="title" placeholder="Otsikko (esim. Valokuvaaja)" required />
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          <input class="input" name="city" placeholder="Paikkakunta" />
          <select class="input" name="category">
            <option>Valokuvaus</option>
            <option>Graafinen suunnittelu</option>
            <option>Verkkosivut</option>
            <option>K√§√§nt√§minen</option>
            <option>Kirjanpito</option>
          </select>
          <input class="input" name="price" type="number" min="0" step="1" placeholder="‚Ç¨/h" />
        </div>
        <input class="input" name="tags" placeholder="Tunnisteet pilkuilla (esim. H√§√§kuvat, Potretit)" />
        <textarea class="input" name="about" placeholder="Kuvaus"></textarea>
        <input class="input" name="stripe_link" placeholder="Stripe-maksulinkki (valinnainen)" />
        <input class="input" name="image_url" placeholder="Kuva (URL)" />
        <div class="flex gap-2">
          <button class="btn btn-primary" type="submit">Tallenna</button>
          <button class="btn btn-outline" type="button" id="btnLoadMine">Lataa oma profiili</button>
        </div>
        <p id="profileInfo" class="text-sm text-slate-600"></p>
      </form>
    </div>
  </section>

  <!-- Admin -->
  <section id="admin" class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 pb-20 hidden">
    <h2 class="text-2xl font-bold">Admin ‚Äì hyv√§ksy profiileja</h2>
    <p class="text-slate-600">N√§kyy vain admin-k√§ytt√§jille (RLS).</p>
    <div id="adminList" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-5 mt-4"></div>
  </section>

  <footer class="py-10 text-center text-sm text-slate-600">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <p>¬© <span id="year"></span> Osaajatori. Kaikki oikeudet pid√§tet√§√§n.</p>
      <div class="mt-2">K√§ytt√∂ehdot ¬∑ Tietosuoja</div>
    </div>
  </footer>

<script>
// Supabase-avain ja URL (sinun projektisi)
const SUPABASE_URL = "https://gnihryjremimweriovza.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImduaWhyeWpyZW1pbXdlcmlvdnphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3NjA5OTIsImV4cCI6MjA3MDMzNjk5Mn0.D5tU7KtcgtO0Q6lnIm5TSBZuiieTAHV1lF3UohSVKiI";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const resultsEl = document.getElementById('results');
const emptyEl = document.getElementById('emptyState');
const sortSelect = document.getElementById('sortSelect');
const profileForm = document.getElementById('profileForm');
const profileInfo = document.getElementById('profileInfo');
const btnLogin = document.getElementById('btnLogin');
const btnLogout = document.getElementById('btnLogout');
const navAdmin = document.getElementById('navAdmin');
const adminSection = document.getElementById('admin');
const adminList = document.getElementById('adminList');

// Auth ‚Äì magic link s√§hk√∂postiin
btnLogin.addEventListener('click', async () => {
  const email = prompt('S√§hk√∂postiosoitteesi kirjautumista varten:');
  if(!email) return;
  const { error } = await supabase.auth.signInWithOtp({ email });
  if(error) alert(error.message); else alert('Tarkista s√§hk√∂posti (magic link).');
});
btnLogout.addEventListener('click', async ()=>{
  await supabase.auth.signOut();
  location.reload();
});

// Session init
(async function(){
  const { data: { session } } = await supabase.auth.getSession();
  toggleAuth(session);
  await renderSearch();
  if(session) await maybeShowAdmin();
})();

supabase.auth.onAuthStateChange(async (_event, session)=>{
  toggleAuth(session);
  await renderSearch();
  if(session) await maybeShowAdmin();
});

function toggleAuth(session){
  const loggedIn = !!(session && session.user);
  btnLogin.style.display = loggedIn ? 'none' : 'inline-flex';
  btnLogout.style.display = loggedIn ? 'inline-flex' : 'none';
}

// Search
async function renderSearch(){
  const q = (document.getElementById('filterQ')?.value || '').trim().toLowerCase();
  const city = (document.getElementById('filterCity')?.value || '').trim().toLowerCase();
  const cat = (document.getElementById('filterCategory')?.value || '');
  const priceEl = document.getElementById('filterPrice');
  const maxPrice = priceEl ? Number(priceEl.value) : 999999;

  let query = supabase.from('profiles').select('*');
  const isAdmin = await iAmAdmin();
  if(!isAdmin){
    query = query.eq('approved', true);
  }
  if(q) query = query.ilike('about', `%${q}%`);
  if(city) query = query.ilike('city', `%${city}%`);
  if(cat) query = query.eq('category', cat);
  if(maxPrice < 999999) query = query.lte('price', maxPrice);

  const { data, error } = await query;
  if(error){ console.error(error); return; }

  const sort = sortSelect.value;
  if(sort === 'rating') data.sort((a,b)=> (b.rating||0) - (a.rating||0));
  if(sort === 'price_asc') data.sort((a,b)=> (a.price||0) - (b.price||0));
  if(sort === 'price_desc') data.sort((a,b)=> (b.price||0) - (a.price||0));

  if(!data.length){ resultsEl.innerHTML=''; emptyEl.classList.remove('hidden'); return; }
  emptyEl.classList.add('hidden');

  resultsEl.innerHTML = data.map(p => `
    <article class="card rounded-2xl overflow-hidden shadow-soft flex flex-col">
      <img src="${p.image_url || 'https://images.unsplash.com/photo-1521737604893-d14cc237f11d?q=80&w=1200&auto=format&fit=crop'}" alt="${p.name || ''}" class="h-40 w-full object-cover"/>
      <div class="p-4 flex flex-col gap-3 grow">
        <div class="flex items-start justify-between gap-2">
          <div>
            <h3 class="font-semibold text-lg">${p.name || ''}</h3>
            <p class="text-slate-600 text-sm">${p.title || ''} ‚Ä¢ ${p.city || ''}</p>
          </div>
          <div class="text-right">
            <div class="font-semibold">${p.price ? p.price+' ‚Ç¨/h' : ''}</div>
            <div class="text-xs text-slate-600">${p.rating ? '\u2605 '+p.rating : ''} ${p.reviews? '('+p.reviews+')':''}</div>
          </div>
        </div>
        <p class="text-sm text-slate-700">${p.about || ''}</p>
        <div class="mt-auto flex flex-wrap gap-2">
          ${(p.tags||[]).map(t => `<span class="chip">${t}</span>`).join('')}
        </div>
        <div class="pt-2 grid grid-cols-2 gap-2">
          ${p.stripe_link ? `<a class="btn btn-primary text-center" href="${p.stripe_link}" target="_blank" rel="noopener">Osta / Maksa</a>` : `<button class="btn btn-primary" disabled>Ei maksulinkki√§</button>`}
          <a class="btn btn-outline text-center" href="mailto:?subject=Tarjouspyynt√∂%20${encodeURIComponent(p.name || '')}&body=Hei!%20Olen%20kiinnostunut%20palvelustasi.">Ota yhteytt√§</a>
        </div>
      </div>
    </article>
  `).join('');
}

// Filters events
sortSelect.addEventListener('change', renderSearch);
document.getElementById('applyFilters').addEventListener('click', renderSearch);
document.getElementById('resetFilters').addEventListener('click', ()=>{
  document.getElementById('filterQ').value = '';
  document.getElementById('filterCity').value = '';
  document.getElementById('filterCategory').value = '';
  document.getElementById('filterPrice').value = 200;
  document.getElementById('priceValue').textContent = '200';
  sortSelect.value = 'relevance';
  renderSearch();
});
document.getElementById('filterPrice').addEventListener('input', (e)=>{
  document.getElementById('priceValue').textContent = e.target.value;
});

// Hero quick search ‚Üí push to filters
const heroForm = document.getElementById('heroSearch');
heroForm.addEventListener('submit', (e)=>{
  e.preventDefault();
  const fd = new FormData(heroForm);
  document.getElementById('filterQ').value = (fd.get('q')||'');
  document.getElementById('filterCity').value = (fd.get('city')||'');
  document.getElementById('filterCategory').value = (fd.get('category')||'');
  location.hash = '#search';
  renderSearch();
});

// Profile create/update (owner, not approved yet)
profileForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const { data: { session } } = await supabase.auth.getSession();
  if(!session) return alert('Kirjaudu ensin.');
  const uid = session.user.id;
  const fd = new FormData(profileForm);
  const payload = {
    user_id: uid,
    name: fd.get('name'),
    title: fd.get('title'),
    city: fd.get('city')||null,
    category: fd.get('category')||null,
    price: fd.get('price')? Number(fd.get('price')) : null,
    tags: (fd.get('tags')||'').split(',').map(s=>s.trim()).filter(Boolean),
    about: fd.get('about')||null,
    stripe_link: fd.get('stripe_link')||null,
    image_url: fd.get('image_url')||null,
  };
  const { data: mine } = await supabase.from('profiles').select('id, approved').eq('user_id', uid).limit(1).maybeSingle();
  let res;
  if(mine){
    res = await supabase.from('profiles').update(payload).eq('id', mine.id).select();
  } else {
    res = await supabase.from('profiles').insert(payload).select();
  }
  if(res.error){ alert(res.error.message); return; }
  profileInfo.textContent = 'Tallennettu. Admin tarkistaa ja hyv√§ksyy ennen julkaisua.';
  alert('Tallennettu. Kun admin hyv√§ksyy, profiili n√§kyy hauissa.');
  await renderSearch();
});

document.getElementById('btnLoadMine').addEventListener('click', async ()=>{
  const { data: { session } } = await supabase.auth.getSession();
  if(!session) return alert('Kirjaudu ensin.');
  const uid = session.user.id;
  const { data, error } = await supabase.from('profiles').select('*').eq('user_id', uid).maybeSingle();
  if(error){ alert(error.message); return; }
  if(!data){ alert('Sinulla ei ole profiilia viel√§.'); return; }
  profileForm.name.value = data.name||'';
  profileForm.title.value = data.title||'';
  profileForm.city.value = data.city||'';
  profileForm.category.value = data.category||'';
  profileForm.price.value = data.price||'';
  profileForm.tags.value = (data.tags||[]).join(', ');
  profileForm.about.value = data.about||'';
  profileForm.stripe_link.value = data.stripe_link||'';
  profileForm.image_url.value = data.image_url||'';
  profileInfo.textContent = data.approved ? 'Profiili on hyv√§ksytty ja n√§kyy julkisesti.' : 'Profiili odottaa hyv√§ksynt√§√§.';
});

// Admin
async function iAmAdmin(){
  const { data: { session } } = await supabase.auth.getSession();
  if(!session) return false;
  const { data } = await supabase.from('admin_users').select('user_id').eq('user_id', session.user.id);
  return !!(data && data.length);
}

async function maybeShowAdmin(){
  if(await iAmAdmin()){
    navAdmin.classList.remove('hidden');
    adminSection.classList.remove('hidden');
    loadAdminList();
  }
}

async function loadAdminList(){
  const { data, error } = await supabase.from('profiles').select('*').order('created_at', { ascending: false });
  if(error){ console.error(error); return; }
  adminList.innerHTML = data.map(p => `
    <article class="card rounded-2xl overflow-hidden shadow-soft flex flex-col">
      <img src="${p.image_url || 'https://images.unsplash.com/photo-1521737604893-d14cc237f11d?q=80&w=1200&auto=format&fit=crop'}" class="h-40 w-full object-cover"/>
      <div class="p-4 flex flex-col gap-2">
        <div class="flex items-start justify-between gap-2">
          <div>
            <h3 class="font-semibold text-lg">${p.name || ''}</h3>
            <p class="text-slate-600 text-sm">${p.title || ''} ‚Ä¢ ${p.city||''}</p>
          </div>
          <div class="text-right text-sm">${p.approved ? '<span class="chip">Hyv√§ksytty</span>' : '<span class="chip">Odottaa</span>'}</div>
        </div>
        <p class="text-sm text-slate-700">${p.about||''}</p>
        <div class="grid grid-cols-2 gap-2 pt-2">
          ${p.approved ? `
            <button class="btn btn-outline" onclick="setApprove('${p.id}', false)">Peru hyv√§ksynt√§</button>
          ` : `
            <button class="btn btn-primary" onclick="setApprove('${p.id}', true)">Hyv√§ksy</button>
          `}
          <button class="btn btn-outline" onclick="delProfile('${p.id}')">Poista</button>
        </div>
      </div>
    </article>
  `).join('');
}

async function setApprove(id, state){
  const { error } = await supabase.from('profiles').update({ approved: state }).eq('id', id);
  if(error){ alert(error.message); return; }
  await loadAdminList();
  await renderSearch();
}

async function delProfile(id){
  if(!confirm('Poistetaanko profiili?')) return;
  const { error } = await supabase.from('profiles').delete().eq('id', id);
  if(error){ alert(error.message); return; }
  await loadAdminList();
  await renderSearch();
}

// Footer year
document.getElementById('year').textContent = new Date().getFullYear();
</script>
</body>
</html>
